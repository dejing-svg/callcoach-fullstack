<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SalesAI CallCoach</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg-dark: #020617;
        --bg-surface: #020617;
        --bg-card: #0b1120;
        --bg-sidebar: #020617;
        --accent: #4f46e5;
        --accent-soft: rgba(79, 70, 229, 0.15);
        --text-main: #f9fafb;
        --text-muted: #9ca3af;
        --border-subtle: #1f2937;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #111827 0, #020617 50%);
        color: var(--text-main);
      }
      .layout {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: 260px;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-subtle);
        padding: 20px 18px;
        display: flex;
        flex-direction: column;
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 26px;
      }
      .logo-icon {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: linear-gradient(135deg, #4f46e5, #22c55e);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
      }
      .logo-text {
        font-size: 18px;
        font-weight: 600;
      }
      .nav-section-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 12px 6px 8px;
      }
      .nav-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        margin: 2px 0;
        border-radius: 10px;
        color: var(--text-muted);
        font-size: 14px;
        cursor: pointer;
        transition: background 0.15s, color 0.15s;
      }
      .nav-item span.icon {
        width: 18px;
        text-align: center;
        font-size: 14px;
      }
      .nav-item.active {
        background: var(--accent-soft);
        color: var(--text-main);
      }
      .nav-item:hover:not(.active) {
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
      }
      .sidebar-footer {
        margin-top: auto;
        padding-top: 16px;
        border-top: 1px solid var(--border-subtle);
        font-size: 12px;
        color: var(--text-muted);
      }
      .sidebar-footer strong {
        color: var(--text-main);
      }

      .main {
        flex: 1;
        padding: 20px 26px 28px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .title-block h1 {
        margin: 0;
        font-size: 22px;
      }
      .title-block p {
        margin: 4px 0 0;
        font-size: 13px;
        color: var(--text-muted);
      }
      .tag-beta {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(34, 197, 94, 0.12);
        border: 1px solid rgba(34, 197, 94, 0.4);
        color: #bbf7d0;
        margin-left: 10px;
      }

      .view {
        display: none;
      }
      .view.active {
        display: block;
      }

      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 14px;
      }
      .card {
        background: var(--bg-card);
        border-radius: 18px;
        padding: 16px 18px;
        border: 1px solid var(--border-subtle);
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      }
      .card h3 {
        margin: 0 0 6px;
        font-size: 14px;
        color: var(--text-muted);
        font-weight: 500;
      }
      .card-big-number {
        font-size: 28px;
        font-weight: 600;
      }
      .card-sub {
        font-size: 12px;
        color: var(--text-muted);
      }
      .pill-soft {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(22, 163, 74, 0.12);
        color: #bbf7d0;
      }
      .pill-soft.down {
        background: rgba(220, 38, 38, 0.12);
        color: #fecaca;
      }

      .section-row {
        display: grid;
        grid-template-columns: 2.2fr 1.4fr;
        gap: 14px;
        margin-top: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        padding: 8px 6px;
        border-bottom: 1px solid #111827;
        text-align: left;
      }
      th {
        color: var(--text-muted);
        font-weight: 500;
        font-size: 12px;
      }
      .status-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #22c55e;
        display: inline-block;
        margin-right: 6px;
      }
      .badge {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid var(--border-subtle);
        color: var(--text-muted);
      }
      .badge.orange {
        border-color: #f97316;
        color: #fed7aa;
        background: rgba(248, 113, 113, 0.04);
      }

      .form-group {
        margin-bottom: 10px;
      }
      .form-group label {
        display: block;
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 4px;
      }
      .input,
      textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #1f2937;
        background: #020617;
        color: var(--text-main);
        font-size: 14px;
      }
      textarea {
        min-height: 80px;
        resize: vertical;
      }
      .btn-primary {
        padding: 8px 16px;
        border-radius: 999px;
        border: none;
        background: var(--accent);
        color: white;
        font-size: 14px;
        cursor: pointer;
      }
      .btn-primary:hover {
        background: #6366f1;
      }
      .integration-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 14px;
      }
      .integration-card h3 {
        margin: 0 0 4px;
      }
      .integration-card p {
        margin: 0 0 10px;
        font-size: 13px;
        color: var(--text-muted);
      }
      .btn-outline {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid #374151;
        background: transparent;
        color: #e5e7eb;
        font-size: 13px;
        cursor: pointer;
      }
      .btn-outline:hover {
        border-color: var(--accent);
      }
      .leaderboard-row-name {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .avatar {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        background: #111827;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: var(--text-muted);
      }

      @media (max-width: 900px) {
        .layout {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
          flex-direction: row;
          overflow-x: auto;
          padding: 10px 12px;
        }
        .sidebar-footer {
          display: none;
        }
        .nav-section-title {
          display: none;
        }
        .main {
          padding: 14px 14px 22px;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div>
          <div class="logo">
            <div class="logo-icon">S</div>
            <div class="logo-text">SalesAI Coach</div>
          </div>

          <div class="nav-section-title">Overview</div>
          <div class="nav-item active" data-view="dashboard">
            <span class="icon">üìä</span>
            <span>Dashboard</span>
          </div>
          <div class="nav-item" data-view="analyze">
            <span class="icon">üß†</span>
            <span>Analyze Call</span>
          </div>
          <div class="nav-item" data-view="recordings">
            <span class="icon">üìû</span>
            <span>All Recordings</span>
          </div>

          <div class="nav-section-title">Coaching</div>
          <div class="nav-item" data-view="team">
            <span class="icon">üèÖ</span>
            <span>Team Performance</span>
          </div>
          <div class="nav-item" data-view="scripts">
            <span class="icon">üìú</span>
            <span>Call Scripts</span>
          </div>

          <div class="nav-section-title">System</div>
          <div class="nav-item" data-view="integrations">
            <span class="icon">‚öôÔ∏è</span>
            <span>Integrations</span>
          </div>
        </div>

        <div class="sidebar-footer">
          Logged in as <strong>Admin</strong><br />
          <span style="font-size: 11px; color: #6b7280"
            >Prototype ‚Äì data resets when server restarts</span
          >
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main">
        <div class="main-header">
          <div class="title-block">
            <h1 id="view-title">Dashboard</h1>
            <p id="view-subtitle">
              Overview of team performance and call metrics.
              <span class="tag-beta">Internal prototype</span>
            </p>
          </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard" class="view active">
          <div class="card-grid">
            <div class="card">
              <h3>Total Calls Analyzed</h3>
              <div class="card-big-number" id="stat-total-calls">0</div>
              <div class="card-sub">vs. last week</div>
            </div>
            <div class="card">
              <h3>Appointment Rate</h3>
              <div class="card-big-number" id="stat-appointment-rate">
                0%
              </div>
              <div class="card-sub">
                <span class="pill-soft">Simulated metric</span>
              </div>
            </div>
            <div class="card">
              <h3>Avg Call Score</h3>
              <div class="card-big-number" id="stat-avg-score">‚Äî</div>
              <div class="card-sub">
                <span class="pill-soft down" id="stat-score-trend"
                  >-0.0% vs last week</span
                >
              </div>
            </div>
          </div>

          <div class="section-row">
            <div class="card">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <h3 style="margin-bottom: 0">Call Volume & Score</h3>
                <span class="badge">Last 7 days (simulated)</span>
              </div>
              <canvas id="chart-volume" height="120"></canvas>
            </div>
            <div class="card">
              <h3>Agent Leaderboard</h3>
              <table id="leaderboard-table">
                <thead>
                  <tr>
                    <th>Agent</th>
                    <th>Avg Score</th>
                    <th>Calls</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ANALYZE CALL VIEW -->
        <section id="view-analyze" class="view">
          <div class="card" style="max-width: 700px">
            <h3>Upload & Analyze Call</h3>
            <form action="/upload" method="POST" enctype="multipart/form-data">
              <div class="form-group">
                <label>Agent name</label>
                <input
                  class="input"
                  type="text"
                  name="agentName"
                  placeholder="e.g. Tim, Wan Li"
                />
              </div>
              <div class="form-group">
                <label>Notes (client, objections, etc.)</label>
                <textarea
                  name="notes"
                  placeholder="e.g. Client was interested but price-sensitive..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>Audio file (MP3/WAV)</label>
                <input type="file" name="audio" accept="audio/*" required />
              </div>
              <button class="btn-primary" type="submit">
                Upload & Analyze
              </button>
            </form>
          </div>
        </section>

        <!-- ALL RECORDINGS VIEW -->
        <section id="view-recordings" class="view">
          <div class="card">
            <h3>All Recordings</h3>
            <table>
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Agent</th>
                  <th>Recording Name</th>
                  <th>Date &amp; Time</th>
                  <th>Score</th>
                  <th>Sentiment</th>
                </tr>
              </thead>
              <tbody id="recordings-body"></tbody>
            </table>
          </div>
        </section>

        <!-- TEAM PERFORMANCE VIEW -->
        <section id="view-team" class="view">
          <div class="section-row">
            <div class="card">
              <h3>Team Performance</h3>
              <p style="margin-top: 0; font-size: 13px; color: var(--text-muted)">
                Agent leaderboard and aggregate coaching metrics (mocked for
                now).
              </p>
              <table>
                <thead>
                  <tr>
                    <th>Agent</th>
                    <th>Avg Score</th>
                    <th>Calls</th>
                  </tr>
                </thead>
                <tbody id="team-table-body"></tbody>
              </table>
            </div>
            <div class="card">
              <h3>Coaching Focus</h3>
              <p
                id="coaching-focus"
                style="font-size: 13px; color: var(--text-muted)"
              >
                Upload more calls to see patterns in objection handling,
                closing, and discovery.
              </p>
            </div>
          </div>
        </section>

        <!-- CALL SCRIPTS VIEW (placeholder) -->
        <section id="view-scripts" class="view">
          <div class="card">
            <h3>Sales Playbooks</h3>
            <p style="font-size: 13px; color: var(--text-muted)">
              Later, this section will hold your outbound / inbound call
              scripts so AI can measure adherence.
            </p>
            <ul style="font-size: 13px; color: var(--text-muted); padding-left: 18px;">
              <li>Outbound Cold Call ‚Äì Version 1.0</li>
              <li>Clinic Appointment Reminder Script</li>
              <li>Finance Lead Discovery Flow</li>
            </ul>
          </div>
        </section>

        <!-- INTEGRATIONS VIEW -->
        <section id="view-integrations" class="view">
          <div class="card">
            <h3>Integrations</h3>
            <p style="font-size: 13px; color: var(--text-muted)">
              Connect your voice providers and storage to automate call
              ingestion. (UI only for now.)
            </p>
            <div class="integration-grid">
              <div class="card integration-card">
                <h3>Yeastar PBX</h3>
                <p>
                  Sync call recordings from your Yeastar cloud PBX and push
                  them into SalesAI for analysis.
                </p>
                <button class="btn-outline">Connect</button>
              </div>
              <div class="card integration-card">
                <h3>Google Meet</h3>
                <p>
                  Import video meeting recordings &amp; transcripts from Google
                  Workspace for AI coaching.
                </p>
                <button class="btn-outline">Connect</button>
              </div>
              <div class="card integration-card">
                <h3>Google Drive</h3>
                <p>
                  Watch specific folders for new audio/video files to analyze
                  automatically.
                </p>
                <button class="btn-outline">Connect</button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      let calls = [];
      let volumeChart;

      // NAVIGATION
      const viewTitles = {
        dashboard: "Dashboard",
        analyze: "Analyze Call",
        recordings: "All Recordings",
        team: "Team Performance",
        scripts: "Call Scripts",
        integrations: "Integrations",
      };
      const viewSubtitles = {
        dashboard: "Overview of team performance and call metrics.",
        analyze: "Upload recordings and send them for analysis.",
        recordings: "History of analyzed calls and coaching reports.",
        team: "Agent leaderboard and aggregate coaching metrics.",
        scripts: "Manage sales playbooks used to score adherence.",
        integrations:
          "Connect Yeastar, Google Meet, and storage for automated ingestion.",
      };

      document
        .querySelectorAll(".nav-item")
        .forEach((item) =>
          item.addEventListener("click", () => switchView(item))
        );

      function switchView(item) {
        const view = item.getAttribute("data-view");
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        item.classList.add("active");

        document
          .querySelectorAll(".view")
          .forEach((v) => v.classList.remove("active"));
        document
          .getElementById(`view-${view}`)
          .classList.add("active");

        document.getElementById("view-title").textContent =
          viewTitles[view];
        document.getElementById("view-subtitle").textContent =
          viewSubtitles[view];
      }

      // DATA FETCH + RENDER
      async function loadCalls() {
        try {
          const res = await fetch("/api/calls");
          calls = await res.json();
          renderRecordings();
          renderDashboard();
          renderTeamView();
        } catch (e) {
          console.error("Failed to load calls", e);
        }
      }

      function renderRecordings() {
        const body = document.getElementById("recordings-body");
        body.innerHTML = "";

        if (!calls.length) {
          body.innerHTML =
            '<tr><td colspan="6" style="padding:14px;color:#6b7280;">No calls yet. Upload a recording to see it here.</td></tr>';
          return;
        }

        calls.forEach((c) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="status-dot"></span></td>
            <td>${c.agentName}</td>
            <td>${c.filename}</td>
            <td>${new Date(c.createdAt).toLocaleString()}</td>
            <td><span class="badge">${c.qualityScore}</span></td>
            <td>${c.sentiment}</td>
          `;
          body.appendChild(tr);
        });
      }

      function groupByAgent() {
        const byAgent = {};
        calls.forEach((c) => {
          const name = c.agentName || "Unknown";
          if (!byAgent[name]) {
            byAgent[name] = { totalScore: 0, count: 0 };
          }
          byAgent[name].totalScore += c.qualityScore || 0;
          byAgent[name].count += 1;
        });
        return byAgent;
      }

      function renderDashboard() {
        const total = calls.length;
        document.getElementById("stat-total-calls").textContent = total;

        // Fake appointment rate: assume 25% if there are calls
        const appointmentRate = total ? 24.8 : 0;
        document.getElementById(
          "stat-appointment-rate"
        ).textContent = `${appointmentRate.toFixed(1)}%`;

        // Avg score
        let avgScore = 0;
        if (total) {
          avgScore =
            calls.reduce(
              (sum, c) => sum + (c.qualityScore || 0),
              0
            ) / total;
        }
        document.getElementById("stat-avg-score").textContent = total
          ? avgScore.toFixed(1)
          : "‚Äî";

        // Leaderboard table
        const byAgent = groupByAgent();
        const rows = Object.entries(byAgent).map(
          ([name, v]) => ({
            name,
            avgScore: v.totalScore / v.count,
            count: v.count,
          })
        );
        rows.sort((a, b) => b.avgScore - a.avgScore);

        const lbBody = document.querySelector(
          "#leaderboard-table tbody"
        );
        lbBody.innerHTML = "";
        rows.forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="leaderboard-row-name">
              <span class="avatar">${r.name
                .slice(0, 2)
                .toUpperCase()}</span>
              <span>${r.name}</span>
            </td>
            <td>${r.avgScore.toFixed(1)}</td>
            <td>${r.count}</td>
          `;
          lbBody.appendChild(tr);
        });

        renderVolumeChart();
      }

      function renderTeamView() {
        const byAgent = groupByAgent();
        const rows = Object.entries(byAgent).map(
          ([name, v]) => ({
            name,
            avgScore: v.totalScore / v.count,
            count: v.count,
          })
        );
        rows.sort((a, b) => b.avgScore - a.avgScore);

        const tb = document.getElementById("team-table-body");
        tb.innerHTML = "";
        rows.forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="leaderboard-row-name">
              <span class="avatar">${r.name
                .slice(0, 2)
                .toUpperCase()}</span>
              <span>${r.name}</span>
            </td>
            <td>${r.avgScore.toFixed(1)}</td>
            <td>${r.count}</td>
          `;
          tb.appendChild(tr);
        });

        const focus = document.getElementById("coaching-focus");
        if (!rows.length) {
          focus.textContent =
            "Upload more calls to see coaching focus by agent.";
        } else {
          const lowest = rows[rows.length - 1];
          focus.textContent = `Early signal: ${
            lowest.name
          } has the lowest average score (${lowest.avgScore.toFixed(
            1
          )}). Focus coaching on objection handling and closing for this agent.`;
        }
      }

      function renderVolumeChart() {
        const ctx = document.getElementById("chart-volume").getContext(
          "2d"
        );

        // very simple "calls per day index" using createdAt weekday
        const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        const counts = [0, 0, 0, 0, 0, 0, 0];
        const scores = [0, 0, 0, 0, 0, 0, 0];

        calls.forEach((c) => {
          const d = new Date(c.createdAt);
          const idx = d.getDay(); // 0 = Sun
          const mapped = idx === 0 ? 6 : idx - 1; // Mon=0
          counts[mapped] += 1;
          scores[mapped] += c.qualityScore || 0;
        });

        const avgScores = counts.map((n, i) =>
          n ? scores[i] / n : 0
        );

        if (volumeChart) volumeChart.destroy();

        volumeChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: days,
            datasets: [
              {
                label: "Calls",
                data: counts,
                yAxisID: "y",
                tension: 0.35,
                borderColor: "rgba(96, 165, 250, 1)",
                backgroundColor: "rgba(96, 165, 250, 0.2)",
                fill: true,
              },
              {
                label: "Avg Score",
                data: avgScores,
                yAxisID: "y1",
                tension: 0.35,
                borderColor: "rgba(129, 140, 248, 1)",
                backgroundColor: "rgba(129, 140, 248, 0.1)",
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: "#6b7280" },
                grid: { color: "#111827" },
              },
              y1: {
                position: "right",
                beginAtZero: true,
                min: 0,
                max: 100,
                ticks: { color: "#6b7280" },
                grid: { display: false },
              },
              x: {
                ticks: { color: "#6b7280" },
                grid: { color: "#111827" },
              },
            },
            plugins: {
              legend: {
                labels: { color: "#9ca3af", boxWidth: 12 },
              },
            },
          },
        });
      }

      loadCalls();
    </script>
  </body>
</html>
