<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SalesAI Coach</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #020617;
        --bg-elevated: #0b1220;
        --border-subtle: #1e293b;
        --primary: #6366f1;
        --primary-soft: rgba(99, 102, 241, 0.12);
        --text: #e5e7eb;
        --text-muted: #9ca3af;
        --danger: #f97373;
        --positive: #4ade80;
        --warning: #facc15;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #111827, #020617);
        color: var(--text);
      }

      .app-shell {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 240px;
        background: linear-gradient(180deg, #020617, #020617, #020617);
        border-right: 1px solid var(--border-subtle);
        padding: 16px 14px;
        display: flex;
        flex-direction: column;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 22px;
      }

      .logo-mark {
        width: 30px;
        height: 30px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #4f46e5, #22c55e);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
      }

      .logo-text {
        font-weight: 600;
        font-size: 17px;
      }

      .nav-section-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin: 14px 6px 6px;
      }

      .nav-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .nav-item {
        padding: 8px 10px;
        border-radius: 8px;
        margin: 2px 0;
        cursor: pointer;
        font-size: 14px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-item span.icon {
        font-size: 14px;
      }

      .nav-item.active {
        background: var(--primary-soft);
        color: var(--text);
      }

      .nav-item:hover {
        background: rgba(148, 163, 184, 0.08);
      }

      .sidebar-footer {
        margin-top: auto;
        font-size: 11px;
        color: var(--text-muted);
        opacity: 0.8;
      }

      /* Main */
      .main {
        flex: 1;
        padding: 16px 24px 32px;
        display: flex;
        flex-direction: column;
      }

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
      }

      .topbar-left h1 {
        font-size: 18px;
        margin: 0;
      }

      .topbar-left p {
        margin: 3px 0 0;
        font-size: 13px;
        color: var(--text-muted);
      }

      .topbar-right {
        font-size: 12px;
        color: var(--text-muted);
      }

      /* Cards */
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 14px;
      }

      .card {
        background: linear-gradient(135deg, #020617, #020617);
        border-radius: 16px;
        border: 1px solid var(--border-subtle);
        padding: 14px 16px;
      }

      .card h3 {
        margin: 0;
        font-size: 14px;
      }

      .card-sub {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      .card-big-number {
        margin-top: 8px;
        font-size: 28px;
        font-weight: 600;
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        border-radius: 999px;
        padding: 2px 9px;
        font-size: 11px;
        background: rgba(148, 163, 184, 0.1);
      }

      .chip.green {
        background: rgba(34, 197, 94, 0.12);
        color: #bbf7d0;
      }

      .chip.red {
        background: rgba(248, 113, 113, 0.12);
        color: #fecaca;
      }

      .chip.blue {
        background: rgba(59, 130, 246, 0.12);
        color: #bfdbfe;
      }

      .section-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 14px;
      }

      /* Tables */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      th,
      td {
        padding: 8px 8px;
        text-align: left;
        border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      }

      th {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
      }

      tr:hover td {
        background: rgba(15, 23, 42, 0.7);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--positive);
        display: inline-block;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: rgba(15, 23, 42, 0.9);
      }

      /* Forms & buttons */
      .form {
        display: grid;
        gap: 12px;
        max-width: 560px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      label {
        font-size: 13px;
      }

      input[type="text"],
      textarea {
        border-radius: 10px;
        border: 1px solid var(--border-subtle);
        padding: 8px 10px;
        font-size: 13px;
        background: rgba(15, 23, 42, 0.9);
        color: var(--text);
        resize: vertical;
        min-height: 36px;
      }

      textarea {
        min-height: 80px;
      }

      input[type="file"] {
        font-size: 13px;
      }

      button,
      .btn {
        border-radius: 999px;
        border: none;
        padding: 7px 14px;
        font-size: 13px;
        cursor: pointer;
        font-weight: 500;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-outline {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border-subtle);
      }

      .btn-primary:hover {
        filter: brightness(1.05);
      }

      .btn-outline:hover {
        background: rgba(15, 23, 42, 0.8);
      }

      /* View container */
      .view {
        display: none;
      }

      .view.active {
        display: block;
      }

      /* Timeline */
      .timeline-pill {
        border-radius: 999px;
        padding: 4px 10px;
        background: rgba(15, 23, 42, 0.9);
      }

      .timeline-pill span {
        margin-right: 6px;
      }

      /* Lists */
      ul {
        margin: 6px 0 0;
      }

      ul li {
        margin-bottom: 4px;
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="logo">
          <div class="logo-mark">S</div>
          <div class="logo-text">SalesAI Coach</div>
        </div>

        <div class="nav-section-title">Overview</div>
        <ul class="nav-list">
          <li
            class="nav-item active"
            data-view="view-dashboard"
            onclick="setView(this)"
          >
            <span class="icon">üìä</span> Dashboard
          </li>
          <li
            class="nav-item"
            data-view="view-analyze"
            onclick="setView(this)"
          >
            <span class="icon">üéß</span> Analyze Call
          </li>
          <li
            class="nav-item"
            data-view="view-recordings"
            onclick="setView(this)"
          >
            <span class="icon">üìÅ</span> All Recordings
          </li>
        </ul>

        <div class="nav-section-title">Coaching</div>
        <ul class="nav-list">
          <li
            class="nav-item"
            data-view="view-team"
            onclick="setView(this)"
          >
            <span class="icon">üèÜ</span> Team Performance
          </li>
          <li
            class="nav-item"
            data-view="view-scripts"
            onclick="setView(this)"
          >
            <span class="icon">üìú</span> Call Scripts
          </li>
        </ul>

        <div class="nav-section-title">System</div>
        <ul class="nav-list">
          <li
            class="nav-item"
            data-view="view-integrations"
            onclick="setView(this)"
          >
            <span class="icon">üîå</span> Integrations
          </li>
        </ul>

        <div class="sidebar-footer">
          Logged in as <strong>Admin</strong><br />
          Prototype ‚Äì data resets when server restarts.
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main">
        <header class="topbar">
          <div class="topbar-left">
            <h1 id="view-title">Dashboard</h1>
            <p id="view-subtitle">
              Overview of team performance and call metrics.
            </p>
          </div>
          <div class="topbar-right">
            CallCoach AI ‚Ä¢
            <span id="call-count-label">0 calls analyzed</span>
          </div>
        </header>

        <!-- DASHBOARD -->
        <section id="view-dashboard" class="view active">
          <div class="card-grid">
            <div class="card">
              <div class="card-sub">Total Calls Analyzed</div>
              <div class="card-big-number" id="dash-total-calls">0</div>
              <div class="chip green" id="dash-change-label">
                +0 vs last period
              </div>
            </div>
            <div class="card">
              <div class="card-sub">Appointment Rate</div>
              <div class="card-big-number" id="dash-appt-rate">0%</div>
              <div style="font-size: 12px; color: var(--text-muted)">
                Based on calls with outcome <strong>Booked</strong>.
              </div>
            </div>
            <div class="card">
              <div class="card-sub">Avg Call Quality Score</div>
              <div class="card-big-number" id="dash-avg-score">0</div>
              <div class="chip blue" id="dash-score-trend">‚Äì</div>
            </div>
          </div>
        </section>

        <!-- ANALYZE CALL -->
        <section id="view-analyze" class="view">
          <div class="card">
            <h3>Upload & Analyze Call</h3>
            <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px">
              Upload a call recording and optionally paste the transcript from
              Yeastar / Google Meet. AI will generate a coaching report.
            </p>

            <form
              class="form"
              style="margin-top: 14px"
              action="/upload"
              method="post"
              enctype="multipart/form-data"
            >
              <div class="form-group">
                <label>Agent Name</label>
                <input
                  type="text"
                  name="agentName"
                  placeholder="e.g. Tim, Wan Li"
                />
              </div>
              <div class="form-group">
                <label>Notes (summary, context)</label>
                <textarea
                  name="notes"
                  placeholder="e.g. Client is a clinic, interested in SEO but price-sensitive..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>Transcript (optional)</label>
                <textarea
                  name="transcript"
                  placeholder="Paste full transcript here for deeper analysis..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>Audio file</label>
                <input type="file" name="audio" accept="audio/*" required />
              </div>
              <div>
                <button type="submit" class="btn-primary">
                  Upload & Analyze
                </button>
              </div>
            </form>
          </div>
        </section>

        <!-- ALL RECORDINGS -->
        <section id="view-recordings" class="view">
          <div class="card">
            <h3>All Recordings</h3>
            <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px">
              History of analyzed calls and coaching reports.
            </p>

            <div style="margin-top: 12px; overflow-x: auto">
              <table>
                <thead>
                  <tr>
                    <th></th>
                    <th>Agent</th>
                    <th>File</th>
                    <th>Date &amp; Time</th>
                    <th>Score</th>
                    <th>Outcome</th>
                    <th>Script Adh.</th>
                    <th>Sentiment</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="recordings-body"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- REPORT VIEW -->
        <section id="view-report" class="view">
          <div class="card">
            <button class="btn-outline" onclick="backToRecordings()">
              ‚Üê Back to Recordings
            </button>
            <h3 id="report-file-title" style="margin-top: 12px">
              Analysis Results
            </h3>
            <p
              id="report-file-sub"
              style="font-size: 13px; color: var(--text-muted); margin-top: 2px"
            ></p>

            <div class="card-grid" style="margin-top: 14px">
              <div class="card">
                <h3>Call Quality Score</h3>
                <div class="card-big-number" id="report-score">‚Äî</div>
                <div style="display: flex; gap: 10px; margin-top: 8px">
                  <div>
                    <div class="card-sub">Sentiment</div>
                    <div id="report-sentiment">‚Äî</div>
                  </div>
                  <div>
                    <div class="card-sub">Conversion Likelihood</div>
                    <div id="report-conversion">‚Äî</div>
                  </div>
                </div>
              </div>

              <div class="card">
                <h3>Script Adherence</h3>
                <div
                  id="report-script-bar"
                  style="
                    margin-top: 10px;
                    width: 100%;
                    height: 8px;
                    background: #020617;
                    border-radius: 999px;
                    overflow: hidden;
                  "
                >
                  <div
                    id="report-script-fill"
                    style="height: 8px; width: 0; background: var(--primary)"
                  ></div>
                </div>
                <div
                  id="report-script-text"
                  style="
                    margin-top: 6px;
                    font-size: 13px;
                    color: var(--text-muted);
                  "
                ></div>
              </div>
            </div>

            <div class="card" style="margin-top: 14px">
              <h3>Call Timeline</h3>
              <div
                id="report-timeline"
                style="
                  display: flex;
                  gap: 10px;
                  margin-top: 10px;
                  flex-wrap: wrap;
                  font-size: 13px;
                  color: var(--text-muted);
                "
              ></div>
            </div>

            <div class="section-row" style="margin-top: 14px">
              <div class="card">
                <h3>Key Objections Raised</h3>
                <ul
                  id="report-objections"
                  style="
                    font-size: 13px;
                    color: var(--text-muted);
                    padding-left: 18px;
                  "
                ></ul>
              </div>
              <div class="card">
                <h3>Coaching Plan</h3>
                <ul
                  id="report-coaching"
                  style="
                    font-size: 13px;
                    color: var(--text-muted);
                    padding-left: 18px;
                  "
                ></ul>
              </div>
            </div>

            <div class="section-row" style="margin-top: 14px">
              <div class="card">
                <h3>What to Keep / Add</h3>
                <ul
                  id="report-strengths"
                  style="
                    font-size: 13px;
                    color: var(--text-muted);
                    padding-left: 18px;
                  "
                ></ul>
                <h4 style="margin-top: 10px; font-size: 13px">
                  Recommended phrases
                </h4>
                <ul
                  id="report-phrases-add"
                  style="
                    font-size: 13px;
                    color: var(--text-muted);
                    padding-left: 18px;
                  "
                ></ul>
              </div>
              <div class="card">
                <h3>What to Remove / Avoid</h3>
                <ul
                  id="report-improvements"
                  style="
                    font-size: 13px;
                    color: var(--text-muted);
                    padding-left: 18px;
                  "
                ></ul>
                <h4 style="margin-top: 10px; font-size: 13px">
                  Phrases to avoid
                </h4>
                <ul
                  id="report-phrases-avoid"
                  style="
                    font-size: 13px;
                    color: var(--text-muted);
                    padding-left: 18px;
                  "
                ></ul>
              </div>
            </div>
          </div>
        </section>

        <!-- TEAM PERFORMANCE (placeholder ‚Äì will hook later) -->
        <section id="view-team" class="view">
          <div class="card">
            <h3>Team Performance</h3>
            <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px">
              Summary of agent scores based on analyzed calls.
            </p>
            <div id="team-performance-body" style="margin-top: 10px"></div>
          </div>
        </section>

        <!-- CALL SCRIPTS (placeholder for now) -->
        <section id="view-scripts" class="view">
          <div class="card">
            <h3>Call Scripts</h3>
            <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px">
              Later we will store your outbound / reminder scripts here and use
              them for strict script adherence scoring.
            </p>
          </div>
        </section>

        <!-- INTEGRATIONS (placeholder) -->
        <section id="view-integrations" class="view">
          <div class="card">
            <h3>Integrations</h3>
            <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px">
              Future: Yeastar PBX, Google Meet, Google Drive ‚Äì to pull
              recordings & transcripts automatically.
            </p>
          </div>
        </section>
      </main>
    </div>

    <script>
      let calls = [];

      function setView(navItem) {
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        navItem.classList.add("active");

        const viewId = navItem.getAttribute("data-view");
        document
          .querySelectorAll(".view")
          .forEach((v) => v.classList.remove("active"));
        document.getElementById(viewId).classList.add("active");

        // Update header text
        switch (viewId) {
          case "view-dashboard":
            document.getElementById("view-title").textContent = "Dashboard";
            document.getElementById("view-subtitle").textContent =
              "Overview of team performance and call metrics.";
            break;
          case "view-analyze":
            document.getElementById("view-title").textContent =
              "Analyze Call";
            document.getElementById("view-subtitle").textContent =
              "Upload a call recording and let AI generate a coaching report.";
            break;
          case "view-recordings":
            document.getElementById("view-title").textContent =
              "All Recordings";
            document.getElementById("view-subtitle").textContent =
              "History of analyzed calls and coaching reports.";
            break;
          case "view-team":
            document.getElementById("view-title").textContent =
              "Team Performance";
            document.getElementById("view-subtitle").textContent =
              "Agent leaderboard based on call quality and adherence.";
            break;
          case "view-scripts":
            document.getElementById("view-title").textContent =
              "Call Scripts";
            document.getElementById("view-subtitle").textContent =
              "Manage scripts that AI uses to measure adherence.";
            break;
          case "view-integrations":
            document.getElementById("view-title").textContent =
              "Integrations";
            document.getElementById("view-subtitle").textContent =
              "Connect Yeastar, Meet and Drive to ingest calls automatically.";
            break;
        }
      }

      async function loadCalls() {
        try {
          const res = await fetch("/api/calls");
          const data = await res.json();
          calls = data || [];

          document.getElementById("call-count-label").textContent =
            calls.length + " calls analyzed";

          renderRecordings();
          renderDashboard();
          renderTeamPerformance();
        } catch (e) {
          console.error("Failed to load calls", e);
        }
      }

      function renderRecordings() {
        const tbody = document.getElementById("recordings-body");
        tbody.innerHTML = "";

        if (!calls.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 9;
          td.textContent = "No calls analyzed yet.";
          td.style.color = "var(--text-muted)";
          tr.appendChild(td);
          tbody.appendChild(tr);
          return;
        }

        calls.forEach((c) => {
          const tr = document.createElement("tr");
          const adhPct = c.scriptAdherence
            ? Math.round(c.scriptAdherence * 100)
            : 0;

          tr.innerHTML = `
            <td><span class="status-dot"></span></td>
            <td>${c.agentName}</td>
            <td>${c.filename}</td>
            <td>${new Date(c.createdAt).toLocaleString()}</td>
            <td><span class="badge">${c.qualityScore ?? "‚Äî"}</span></td>
            <td>${c.appointmentOutcome || "‚Äî"}</td>
            <td>${adhPct}%</td>
            <td>${c.sentiment || "‚Äî"}</td>
            <td>
              <button class="btn-outline" onclick="openReport(${
                c.id
              })">View report</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      function renderDashboard() {
        const total = calls.length;
        document.getElementById("dash-total-calls").textContent = total;

        if (!total) {
          document.getElementById("dash-appt-rate").textContent = "0%";
          document.getElementById("dash-avg-score").textContent = "0";
          return;
        }

        const booked = calls.filter(
          (c) => c.appointmentOutcome === "Booked"
        ).length;
        const rate = Math.round((booked / total) * 100);
        const avgScore =
          Math.round(
            (calls.reduce((sum, c) => sum + (c.qualityScore || 0), 0) /
              total) *
              10
          ) / 10;

        document.getElementById("dash-appt-rate").textContent =
          rate + "%";
        document.getElementById("dash-avg-score").textContent =
          avgScore || 0;
      }

      function renderTeamPerformance() {
        const container = document.getElementById("team-performance-body");
        container.innerHTML = "";

        if (!calls.length) {
          container.style.fontSize = "13px";
          container.style.color = "var(--text-muted)";
          container.textContent =
            "Run a few analyses first ‚Äì team stats will appear here.";
          return;
        }

        const byAgent = {};
        calls.forEach((c) => {
          if (!byAgent[c.agentName]) {
            byAgent[c.agentName] = { count: 0, scoreSum: 0 };
          }
          byAgent[c.agentName].count += 1;
          byAgent[c.agentName].scoreSum += c.qualityScore || 0;
        });

        const list = Object.entries(byAgent)
          .map(([name, v]) => ({
            name,
            avg: Math.round((v.scoreSum / v.count) * 10) / 10,
            count: v.count,
          }))
          .sort((a, b) => b.avg - a.avg);

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Agent</th>
              <th>Avg Score</th>
              <th>Calls</th>
            </tr>
          </thead>
          <tbody>
            ${list
              .map(
                (row) => `
              <tr>
                <td>${row.name}</td>
                <td>${row.avg}</td>
                <td>${row.count}</td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        `;
        container.appendChild(table);
      }

      async function openReport(id) {
        try {
          const res = await fetch(`/api/calls/${id}`);
          if (!res.ok) {
            alert("Report not found");
            return;
          }
          const c = await res.json();

          // Switch view (no sidebar highlight change)
          document
            .querySelectorAll(".view")
            .forEach((v) => v.classList.remove("active"));
          document.getElementById("view-report").classList.add("active");

          document.getElementById("view-title").textContent =
            "Analysis Results";
          document.getElementById("view-subtitle").textContent =
            "Detailed AI breakdown of one call for coaching and script adherence.";

          document.getElementById("report-file-title").textContent =
            "Analysis Results ‚Äì " + c.filename;
          document.getElementById("report-file-sub").textContent =
            c.agentName +
            " ‚Ä¢ " +
            new Date(c.createdAt).toLocaleString();

          document.getElementById("report-score").textContent =
            (c.qualityScore || 0) + "/100";
          document.getElementById("report-sentiment").textContent =
            c.sentiment || "‚Äî";
          document.getElementById("report-conversion").textContent =
            c.conversionLikelihood || "‚Äî";

          const adhPct = c.scriptAdherence
            ? Math.round(c.scriptAdherence * 100)
            : 0;
          document.getElementById("report-script-fill").style.width =
            adhPct + "%";
          document.getElementById("report-script-text").textContent =
            "Estimated adherence to script: " + adhPct + "%";

          const tl = document.getElementById("report-timeline");
          tl.innerHTML = "";
          (c.callTimeline || []).forEach((item) => {
            const div = document.createElement("div");
            div.className = "timeline-pill";
            div.innerHTML = `<span class="badge">${item.label}</span> ${
              item.description || ""
            }`;
            tl.appendChild(div);
          });

          const fillList = (id, items) => {
            const el = document.getElementById(id);
            el.innerHTML = "";
            (items || []).forEach((txt) => {
              const li = document.createElement("li");
              li.textContent = txt;
              el.appendChild(li);
            });
          };

          fillList("report-objections", c.keyObjections);
          fillList("report-coaching", c.coachingPlan);
          fillList("report-strengths", c.strengths);
          fillList("report-improvements", c.improvements);
          fillList("report-phrases-add", c.recommendedPhrases);
          fillList("report-phrases-avoid", c.phrasesToAvoid);
        } catch (e) {
          console.error(e);
          alert("Failed to load report.");
        }
      }

      function backToRecordings() {
        document
          .querySelectorAll(".view")
          .forEach((v) => v.classList.remove("active"));
        document.getElementById("view-recordings").classList.add("active");
        document.getElementById("view-title").textContent =
          "All Recordings";
        document.getElementById("view-subtitle").textContent =
          "History of analyzed calls and coaching reports.";
      }

      // Initial load
      loadCalls();
    </script>
  </body>
</html>
